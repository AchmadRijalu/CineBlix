name: Cineblix Unit Test
run-name: ğŸš€ ${{ github.actor }} pushed to ${{ github.ref }}

on:
  push:
    branches:
      - main

jobs:
  test:
    name: Run Unit Tests
    runs-on: macos-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: List available simulators
        run: |
          echo "Available iOS Simulators:"
          xcrun simctl list devices available iOS
      
      - name: Run Unit Tests
        id: run_tests
        run: |
          xcodebuild \
            -project CineBlix.xcodeproj \
            -scheme CineblixTest \
            -destination 'platform=iOS Simulator,name=iPhone 15 Pro' \
            clean test
        continue-on-error: true
      
      - name: Set test status
        run: |
          if [ "${{ steps.run_tests.outcome }}" == "success" ]; then
            echo "TEST_RESULT=âœ… Tests Passed" >> $GITHUB_ENV
            echo "TEST_EMOJI=ğŸ‰" >> $GITHUB_ENV
          else
            echo "TEST_RESULT=âŒ Tests Failed" >> $GITHUB_ENV
            echo "TEST_EMOJI=âš ï¸" >> $GITHUB_ENV
          fi
      
      - name: Send email notification
        if: always()
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 465
          username: ${{ secrets.EMAIL_USERNAME }}
          password: ${{ secrets.EMAIL_PASSWORD }}
          subject: "${{ env.TEST_EMOJI }} CineBlix Tests - ${{ github.ref_name }}"
          to: achmad.rijalu@gmail.com
          from: GitHub Actions <noreply@github.com>
          body: |
            ${{ env.TEST_RESULT }}
            
            ğŸ“¦ Repository: ${{ github.repository }}
            ğŸŒ¿ Branch: ${{ github.ref_name }}
            ğŸ‘¤ Author: ${{ github.actor }}
            ğŸ“ Commit: ${{ github.event.head_commit.message }}
            
            ğŸ”— View Run: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
